# https://wiki.seeedstudio.com/xiao_075inch_epaper_panel/#hardware-overview
esphome:
  name: epaper-display
  friendly_name: epaper_display

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

<<: !include common.yaml

# Display info via SPI
spi:
  clk_pin: GPIO8
  mosi_pin: GPIO10

globals:
  - id: wifi_status
    type: int
    restore_value: no
    initial_value: "0"
  - id: first_update_done
    type: bool
    restore_value: no
    initial_value: "false"

wifi:
  ssid: "SSID"
  password: !secret wifi_password
  on_connect:
    then:
      - lambda: |-
          id(wifi_status) = 1;
  on_disconnect:
    then:
      - lambda: |-
          id(wifi_status) = 0;

# When device in deep sleep mode, you can't upload a new program derectly.
# First, make sure that device is turned on, and then press the Boot button on the back of the board.
# Click one time Reset button and release Boot button.
# After that, turn off the battery switch and unplug the power cable.
# Last, replug the cable and upload a new program.
deep_sleep:
  id: deep_sleep_1
  run_duration: 1min # Device wake up and run 60s (enough to pull data and update)
  sleep_duration: 30min  # deep sleep for 30min

interval:
  # Deep sleep
  - interval: 59s  # run this command before the end of run_duration
    then:
      - logger.log: "Entering deep sleep now momentarily..."

  # Sleep after 11:55PM until 07:30AM
  - interval: 10s
    then:
      - if:
          condition:
            lambda: |-
              auto now = id(homeassistant_time).now();
              ESP_LOGD("main", "Evaluating");
              return now.is_valid() && now.hour == 00;
          then:
            - logger.log: "After 12:00AM â€” entering deep sleep until 08:00."
            - deep_sleep.enter:
                id: deep_sleep_1
                until: "08:00:00"
                time_id: homeassistant_time

  # Condition: wifi connected && data retrieved && first time
  - interval: 10s  # Check every second
    then:
      - if:
          condition:
            and:
              - wifi.connected:
              - lambda: "return !id(first_update_done);"
          then:
            - delay: 5s
            - lambda: |-
                ESP_LOGD("Display", "Triggered Display Update...");
            - component.update: my_display
            - lambda: "id(first_update_done) = true;"

# Connect to Home Assistant to get time
time:
  - platform: homeassistant
    id: homeassistant_time

text_sensor:
  - platform: homeassistant
    entity_id: weather.kcll_daynight
    id: myWeather
  - platform: homeassistant
    entity_id: sensor.433_weather_temperature
    id: temp
  # - platform: homeassistant
  #   entity_id: weather.kcll_daynight
  #   id: temp
  #   attribute: "temperature"
  - platform: homeassistant
    entity_id: sensor.433_weather_humidity
    id: humi
  # - platform: homeassistant
  #   entity_id: weather.kcll_daynight
  #   id: humi
  #   attribute: "humidity"
  - platform: homeassistant
    entity_id: weather.kcll_daynight
    id: press
    attribute: "pressure"
  - platform: homeassistant
    entity_id: weather.kcll_daynight
    id: wind
    attribute: "wind_speed"
  - platform: homeassistant
    entity_id: sensor.solark_sol_ark_day_pv_energy
    id: production
  - platform: homeassistant
    entity_id: sensor.solark_sol_ark_battery_soc
    id: battery
  - platform: homeassistant
    entity_id: sensor.solark_sol_ark_day_grid_export
    id: grid_export
  - platform: homeassistant
    entity_id: sensor.solark_sol_ark_day_grid_import
    id: grid_import
  - platform: homeassistant
    entity_id: sensor.forecast_twice_daily
    id: forecast
    attribute: "detailed_description"
  - platform: homeassistant
    entity_id: input_select.epaper_toggle
    id: toggle

font:
  - file: "fonts/Montserrat-Black.ttf"
    id: web_font
    size: 20
  - file: "fonts/Montserrat-Black.ttf"
    id: update_font
    size: 12
  - file: "fonts/Montserrat-Black.ttf"
    id: data_font
    size: 50
  - file: "fonts/Montserrat-Black.ttf"
    id: title_font
    size: 45
  - file: "fonts/Montserrat-Black.ttf"
    id: sensor_font
    size: 22
  - file: "gfonts://Inter@700"
    id: font1
    size: 24

  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: font_mdi_large
    size: 200
    glyphs: &mdi-weather-glyphs
      - "\U000F050F" # Thermometer
      - "\U000F058E" # Humidity
      - "\U000F059D" # Wind speed
      - "\U000F0D60" # Atmospheric pressure
      - "\U000F0590" # Cloudy weather
      - "\U000F0596" # Rainy weather
      - "\U000F0598" # Snowy weather
      - "\U000F0599" # Sunny weather
      - "\U000F0D9B" # Solar
      - "\U000F008B" # Battery
  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: font_weather
    size: 200
    glyphs: *mdi-weather-glyphs
  - file: 'fonts/materialdesignicons-webfont.ttf'
    id: img_font_sensor
    size: 60
    glyphs: *mdi-weather-glyphs

display:
  - platform: waveshare_epaper
    id: my_display
    cs_pin: GPIO3
    dc_pin: GPIO5
    busy_pin: GPIO4
    reset_pin: GPIO2
    model: 7.50inv2
    update_interval: never
    lambda: |-
      // 1. GLOBAL INVERSION
      it.fill(COLOR_ON);

      if(id(wifi_status) != 0) {
        auto time_now = id(homeassistant_time).now();
        int w = 210, h = 110, r = 12, thickness = 4; // Slightly wider and shorter boxes for better proportions

        // --- HEADER SECTION ---
        std::string weather_string = id(myWeather).state.c_str();
        const char* weather_icon = "\U000F0590"; 
        if(weather_string == "rainy" || weather_string == "lightning" || weather_string == "pouring") weather_icon = "\U000F0596";
        else if(weather_string == "snowy") weather_icon = "\U000F0598";
        else if(weather_string == "sunny" || weather_string == "windy") weather_icon = "\U000F0599";
        
        it.printf(110, 85, id(font_weather), COLOR_OFF, TextAlign::CENTER, weather_icon);

        const char* months[] = {"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"};
        const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
        
        it.printf(230, 80, id(title_font), COLOR_OFF, "%s %d", months[time_now.month - 1], time_now.day_of_month);
        it.printf(230, 30, id(title_font), COLOR_OFF, "%s", days[time_now.day_of_week]);

        // --- UNIFIED BOX LAMBDA ---
        auto draw_stat_box = [&](int x, int y, const char* title, const char* icon, float val) {
          // Frame
          it.filled_rectangle(x + r, y, w - 2 * r, thickness, COLOR_OFF); 
          it.filled_rectangle(x + r, y + h - thickness, w - 2 * r, thickness, COLOR_OFF);
          it.filled_rectangle(x, y + r, thickness, h - 2 * r, COLOR_OFF);
          it.filled_rectangle(x + w - thickness, y + r, thickness, h - 2 * r, COLOR_OFF);
          it.filled_circle(x + r, y + r, r, COLOR_OFF);
          it.filled_circle(x + w - r, y + r, r, COLOR_OFF);
          it.filled_circle(x + r, y + h - r, r, COLOR_OFF);
          it.filled_circle(x + w - r, y + h - r, r, COLOR_OFF);
          it.filled_rectangle(x + thickness, y + thickness, w - 2 * thickness, h - 2 * thickness, COLOR_ON);

          // Title at top left
          it.printf(x + 12, y + 12, id(sensor_font), COLOR_OFF, title);
          
          // Icon - Centered vertically in the lower half
          it.printf(x + 45, y + 75, id(img_font_sensor), COLOR_OFF, TextAlign::CENTER, icon);
          
          // Value
          it.printf(x + w - 30, y + 90, id(data_font), COLOR_OFF, TextAlign::BASELINE_RIGHT, "%.0f", val);
          // X larger = right
          // Y larger = down
        };

        // --- GRID POSITIONS (Optimized for 800px width) ---
        // Column 1 (Weather)
        draw_stat_box(50, 190, "Temperature", "\U000F050F", atof(id(temp).state.c_str()));
        draw_stat_box(50, 330, "Pressure",    "\U000F0D60", atof(id(press).state.c_str()));
        
        // Column 2 (Weather)
        draw_stat_box(300, 190, "Humidity",    "\U000F058E", atof(id(humi).state.c_str()));
        draw_stat_box(300, 330, "Wind Speed",  "\U000F059D", atof(id(wind).state.c_str()));

        // Column 3 (Solar)
        draw_stat_box(560, 50,  "Production",  "\U000F0D9B", atof(id(production).state.c_str()));
        draw_stat_box(560, 190, "Export",      "\U000F0D9B", atof(id(grid_export).state.c_str()));
        draw_stat_box(560, 330, "Battery",     "\U000F008B", atof(id(battery).state.c_str()));
        
        // Last update time
        it.strftime(5, 462, id(update_font), COLOR_OFF, "Updated %b %d, %Y %I:%M %p", time_now);
      }

# Or show image
# http_request:
#   verify_ssl: false
#   timeout: 10s
#   watchdog_timeout: 15s

# online_image:
#   - id: dashboard_image
#     format: PNG
#     type: BINARY
#     buffer_size: 30000
#     url: http://192.168.1.191:10000/todo?viewport=800x480&eink=2&invert #change this link to your screenshot link
#     update_interval: 30s
#     on_download_finished:
#       - delay: 0ms
#       - component.update: main_display

# display:
#   - platform: waveshare_epaper
#     id: main_display
#     cs_pin: GPIO3
#     dc_pin: GPIO5
#     busy_pin: GPIO4
#     reset_pin: GPIO2
#     model: 7.50inv2
#     update_interval: never
#     lambda: |-
#       it.image(0, 0, id(dashboard_image));